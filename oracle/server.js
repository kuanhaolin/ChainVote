require('dotenv').config();
const express = require('express');
const cors = require('cors');
const app = express();

app.use(cors());
app.use(express.json());

// simulated verification db
const govdb =[
    {id: 1, idcard: "1111", healthcard: "1111", commitment: "936107041880948892627387585343503772163411492212883657371352110448043907916", root: "1957502675450735006995294171749393708380816510550016513572325377928709312799", nullifier: "222222", pathElements:["19690291642042494239924132103815711450334047642868793290286571338144171123023", "1036650162605266689155569618988935551591700558940979379371025402092498979322", "17318907088932163993936474574301200048277266577227880388615604770703611868473"], pathIndices:["0", "0", "0"]},
    {id: 2, idcard: "2222", healthcard: "2222", commitment: "19690291642042494239924132103815711450334047642868793290286571338144171123023", root: "1957502675450735006995294171749393708380816510550016513572325377928709312799", nullifier: "222222", pathElements:["936107041880948892627387585343503772163411492212883657371352110448043907916", "1036650162605266689155569618988935551591700558940979379371025402092498979322", "17318907088932163993936474574301200048277266577227880388615604770703611868473"], pathIndices:["1", "0", "0"]},
    {id: 3, idcard: "3333", healthcard: "3333", commitment: "17655239229322083820232532186697763406298275446239639267730473604556012682950", root: "1957502675450735006995294171749393708380816510550016513572325377928709312799", nullifier: "222222", pathElements:["21327735939661307440800272037408205556275099435297611196870074079183395690176", "298403764318384535391080516430271416328384684759174479700768661756576886841", "17318907088932163993936474574301200048277266577227880388615604770703611868473"], pathIndices:["0", "1", "0"]},
    {id: 4, idcard: "4444", healthcard: "4444", commitment: "21327735939661307440800272037408205556275099435297611196870074079183395690176", root: "1957502675450735006995294171749393708380816510550016513572325377928709312799", nullifier: "222222", pathElements:["17655239229322083820232532186697763406298275446239639267730473604556012682950", "298403764318384535391080516430271416328384684759174479700768661756576886841", "17318907088932163993936474574301200048277266577227880388615604770703611868473"], pathIndices:["1", "1", "0"]},
    {id: 5, idcard: "5555", healthcard: "5555", commitment: "17335417660864987354678670922850205919151640126204131061303827322575941656848", root: "1957502675450735006995294171749393708380816510550016513572325377928709312799", nullifier: "222222", pathElements:["2402940869403404244864558063085056800950375796069312073883409745963248554662", "7448170595353527003863672443603688873547380028794982484418939571913494408099", "9438425462009327938113632977103012024864684806479150699875830550507114947861"], pathIndices:["0", "0", "1"]},
    {id: 6, idcard: "6666", healthcard: "6666", commitment: "2402940869403404244864558063085056800950375796069312073883409745963248554662", root: "1957502675450735006995294171749393708380816510550016513572325377928709312799", nullifier: "222222", pathElements:["17335417660864987354678670922850205919151640126204131061303827322575941656848", "7448170595353527003863672443603688873547380028794982484418939571913494408099", "9438425462009327938113632977103012024864684806479150699875830550507114947861"], pathIndices:["1", "0", "1"]},
    {id: 7, idcard: "7777", healthcard: "7777", commitment: "12871884485430907466493029987701833346078251761744937672765509143535891807609", root: "1957502675450735006995294171749393708380816510550016513572325377928709312799", nullifier: "222222", pathElements:["3925193791967034329860766097738798776908475099659776634683788965881451539189", "574638457005259185998031631942469350070264178173448628390443390863409788906", "9438425462009327938113632977103012024864684806479150699875830550507114947861"], pathIndices:["0", "1", "1"]},
    {id: 8, idcard: "8888", healthcard: "8888", commitment: "3925193791967034329860766097738798776908475099659776634683788965881451539189", root: "1957502675450735006995294171749393708380816510550016513572325377928709312799", nullifier: "222222", pathElements:["12871884485430907466493029987701833346078251761744937672765509143535891807609", "574638457005259185998031631942469350070264178173448628390443390863409788906", "9438425462009327938113632977103012024864684806479150699875830550507114947861"], pathIndices:["1", "1", "1"]},
]

// post
app.post('/api/verify', async (req, res) => {
    const { idCardNumber, healthCardNumber} = req.body;
    const founduser = govdb.find(user => user.idcard === idCardNumber && user.healthcard === healthCardNumber);
    
    if (founduser) {
        res.json({verified: true, message: "Success", root: founduser.root, nullifier: founduser.nullifier, pathElements: founduser.pathElements, pathIndices: founduser.pathIndices});
    } else {
        res.json({ verified: false, message: "Failed" });
    }
});

app.listen(3001, () => {
    console.log("Oracle on http://localhost:3001");
});